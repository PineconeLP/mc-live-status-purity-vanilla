version: '3.3'
services:
  authdb:
    image: mcr.microsoft.com/mssql/server:2017-latest
    environment:
      ACCEPT_EULA: 'Y'
      SA_PASSWORD: '${DATABASE_SA_PASSWORD}'
      MSSQL_PID: 'Express'
    ports:
      - '1433:1433'
    volumes:
      - 'auth-data:/var/opt/mssql/data'

  azurite:
    image: mcr.microsoft.com/azure-storage/azurite
    ports:
      - '10000:10000'
      - '10001:10001'

  authfunctions:
    build:
      context: ../authentication-functions
      dockerfile: Dockerfile.Development
    environment:
      AzureWebJobsStorage: '${AZURE_STORAGE_CONNECTION_STRING}'
      SqlServerConnectionString: 'Server=authdb,1433;Initial Catalog=LiveStatus;User ID=sa;Password=${DATABASE_SA_PASSWORD};'
      Authentication_AccessTokenSecret: '${AUTHENTICATION_ACCESS_TOKEN_SECRET}'
      Authentication_RefreshTokenSecret: '7fG65iUioPT55s9oKwSngv28DDLH3jO9BErlbuID50uR876pmy-yWfRn_SK46nH6lG14vtnZOssYP6_JvDRuaYpa1dSImDi7bijYt24ZzosOyoeeXSEF2_rHqIqlLAyyCEdDiPvUyyzIVNM-dIvnk5FMaoQdV56Gy-nvlTT-Wj8'
      Authentication_Issuer: '${AUTHENTICATION_ISSUER}'
      Authentication_Audience: '${AUTHENTICATION_AUDIENCE}'
    ports:
      - '7072:7072'

  pingerfunctions:
    build:
      context: ../blazor-purity-vanilla-functions
      dockerfile: Dockerfile.Development
    env_file:
      # Contains AzureSignalRConnectionString
      - pinger-functions-secrets.env
    environment:
      AzureWebJobsStorage: '${AZURE_STORAGE_CONNECTION_STRING}'
    ports:
      - '7071:7071'

  settingsfunctions:
    build:
      context: ../
      dockerfile: settings-functions/Dockerfile.Development
    environment:
      AzureWebJobsStorage: '${AZURE_STORAGE_CONNECTION_STRING}'
      Authentication_AccessTokenSecret: '${AUTHENTICATION_ACCESS_TOKEN_SECRET}'
      Authentication_Issuer: '${AUTHENTICATION_ISSUER}'
      Authentication_Audience: '${AUTHENTICATION_AUDIENCE}'
    ports:
      - '7073:7073'

volumes:
  auth-data:
